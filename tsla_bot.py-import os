import os
import requests
from datetime import datetime

# å–å¾— TSLA æ”¶ç›¤åƒ¹
def get_tsla_close():
    url = "https://query1.finance.yahoo.com/v8/finance/chart/TSLA"
    res = requests.get(url)
    data = res.json()
    closes = data["chart"]["result"][0]["indicators"]["quote"][0]["close"]
    close_price = [c for c in closes if c is not None][-1]
    return round(close_price, 2)

# æš«æ™‚æ‰‹å‹•æŒ‡å®š Max Painï¼Œå¾ŒçºŒæœƒåŠ è‡ªå‹•çˆ¬èŸ²
def get_max_pain():
    return 315.0

# å¯«å…¥ Notion
def write_to_notion(token, db_id, close_price, max_pain):
    url = "https://api.notion.com/v1/pages"
    headers = {
        "Authorization": f"Bearer {token}",
        "Notion-Version": "2022-06-28",
        "Content-Type": "application/json"
    }
    payload = {
        "parent": { "database_id": db_id },
        "properties": {
            "ğŸ“… æ—¥æœŸ": {
                "date": { "start": datetime.now().strftime("%Y-%m-%d") }
            },
            "æ”¶ç›¤åƒ¹": {
                "number": close_price
            },
            "Max Pain": {
                "number": max_pain
            }
        }
    }
    res = requests.post(url, headers=headers, json=payload)
    return res.status_code

# ç™¼é€ Telegram é€šçŸ¥
def send_telegram(token, chat_id, msg):
    url = f"https://api.telegram.org/bot{token}/sendMessage"
    data = {
        "chat_id": chat_id,
        "text": msg
    }
    requests.post(url, data=data)

# ä¸»ç¨‹å¼
if __name__ == "__main__":
    NOTION_TOKEN = os.environ["NOTION_TOKEN"]
    NOTION_DB_ID = os.environ["NOTION_DB_ID"]
    TG_TOKEN = os.environ["TG_TOKEN"]
    TG_CHAT_ID = os.environ["TG_CHAT_ID"]

    close = get_tsla_close()
    pain = get_max_pain()
    notion_status = write_to_notion(NOTION_TOKEN, NOTION_DB_ID, close, pain)

    if notion_status == 200:
        send_telegram(TG_TOKEN, TG_CHAT_ID, f"âœ… TSLA å·²æ›´æ–°\næ”¶ç›¤åƒ¹ï¼š${close}\nMax Painï¼š${pain}\nå·²å¯«å…¥ Notionã€‚")
    else:
        send_telegram(TG_TOKEN, TG_CHAT_ID, "âŒ Notion å¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ APIã€‚")
